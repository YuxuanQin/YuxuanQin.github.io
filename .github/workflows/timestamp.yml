name: Update HTML Date

on:
  push:
    branches:
      - main  # 可以根据需要修改分支名称

jobs:
  update-date:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # 获取最近两次提交，用于比较变化

      - name: Check for HTML file changes
        id: check-changes
        run: |
          # 获取上一次提交和当前提交之间的差异
          changed_files=$(git diff --name-only HEAD^ HEAD -- '**.html')
          if [ -z "$changed_files" ]; then
            echo "No HTML files changed. Skipping workflow."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "HTML files changed. Proceeding with updates."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if no changes
        if: steps.check-changes.outputs.skip == 'true'
        run: exit 0

      - name: Set up Python
        if: steps.check-changes.outputs.skip == 'false'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        if: steps.check-changes.outputs.skip == 'false'
        run: |
          python -m pip install --upgrade pip
          pip install pytz

      - name: Update HTML files with date
        if: steps.check-changes.outputs.skip == 'false'
        run: |
          for file in $(git diff --name-only HEAD^ HEAD -- '**.html'); do
            if [ -f "$file" ]; then
              # 获取当前日期并转换为中文格式
              current_date=$(TZ=Asia/Shanghai date +"%Y年%m月%d日")
              current_date=$(echo $current_date | sed -e 'y/0123456789/〇一二三四五六七八九/')
              # 格式化日期为右对齐
              formatted_date="<div style='text-align: right;'>$current_date</div>"
              # 将日期追加到文件末尾
              echo "$formatted_date" >> "$file"
            fi
          done

      - name: Commit and push changes
        if: steps.check-changes.outputs.skip == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Automatically update HTML files with current date"
          git push
